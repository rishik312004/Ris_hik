import numpy as np
import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers,models
from tensorflow.keras.models import Sequential
import matplotlib.pyplot as plt
data_train_path='training data set path'
data_test_path='testing data set apth'
img_width=180
img_height=180
data_train=tf.keras.utils.image_dataset_from_directory(data_train_path,image_size=(img_width,img_height),shuffle=True,batch_size=32,
                                                       validation_split=False)
data_test=tf.keras.utils.image_dataset_from_directory(data_test_path,image_size=(img_width,img_height),shuffle=True,batch_size=32,
                                                      validation_split=False)
data_cat=data_train.class_names
plt.figure(figsize=(10,10))
for image,labels in data_train.take(1):
  for i in range(9):
    plt.subplot(3,3,i+1)
    plt.imshow(image[i].numpy().astype('uint8'))
    plt.title(data_cat[labels[i]])
    plt.axis('off')
#BUILDING MODEL USING FUNCTIONAL API
input_layer=layers.Input(shape=(img_width,img_height,3))
x=layers.Conv2D(filters=16,kernel_size=3,activation='relu')(input_layer)
x=layers.BatchNormalization()(x)
x= layers.MaxPooling2D()(x)
x=layers.Conv2D(filters=32,kernel_size=3,activation='relu')(input_layer)
x=layers.BatchNormalization()(x)
x=layers.MaxPooling2D()(x)
x=layers.Conv2D(filters=64,kernel_size=3,activation='relu')(input_layer)
x=layers.BatchNormalization()(x)
x=layers.MaxPooling2D()(x)
x=layers.Flatten()(x)
x=layers.Dense(64,activation='relu')(x)
x=layers.Dropout(0.5)(x)
output_layer=layers.Dense(len(data_cat),activation='softmax')(x)
model=models.Model(input_layer,output_layer)
model.compile(optimizer='adam',loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True),metrics=['accuracy'])
history=model.fit(data_train,epochs=25,batch_size=32,verbose=1)
epochs_range=range(25)
plt.figure(figsize=(8,8))
plt.subplot(1,2,2)
plt.plot(epochs_range,history.history['accuracy'],label='Training Accuracy')
#plt.plot(epochs_range,history.history['val_accuracy'],label='Validation Accuracy')
plt.title('Training Accuracy')
plt.show()
image_path='TEST IMAGE PATH'
image=tf.keras.utils.load_img(image_path,target_size=(img_width,img_height))
img_arr=tf.keras.utils.img_to_array(image)
img_bat=tf.expand_dims(img_arr,0)
predict=model.predict(img_bat)
score=tf.nn.softmax(predict)
print('image is {} with accuracy of {:0.2f}'.format(data_cat[np.argmax(score)], np.max(score)*100))
model.save('pill.keras')
